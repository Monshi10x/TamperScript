<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spandex Products — Cards</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#0b0f14; color:#e8eef6; }
    header { position: sticky; top:0; z-index: 10; background: rgba(11,15,20,.92); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,.08); padding:14px 16px; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 18px; margin: 0 0 10px; font-weight: 800; }
    .controls { display:grid; grid-template-columns: 1fr 170px 220px 160px 160px; gap:10px; align-items:center; }
    @media (max-width: 980px) { .controls { grid-template-columns: 1fr 1fr; } }
    input[type="search"], select, button, input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color:#e8eef6; outline:none;
    }
    button { cursor:pointer; background: rgba(64,140,255,.18); border-color: rgba(64,140,255,.35); font-weight:750; }
    button:hover { background: rgba(64,140,255,.26); }
    .toggle {
      display:inline-flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      user-select:none;
    }
    .toggle input { transform: scale(1.1); }
    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:10px; flex-wrap:wrap; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); font-size:12px; color: rgba(232,238,246,.9); }
    .dot { width:10px; height:10px; border-radius:999px; background:#777; border:1px solid rgba(255,255,255,.25); }
    main { padding: 16px; }
    .status { padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); margin: 12px 0; font-size: 13px; color: rgba(232,238,246,.85); }
    .status.error { border-color: rgba(255,90,90,.35); background: rgba(255,90,90,.10); }
    .status.ok    { border-color: rgba(90,255,170,.25); background: rgba(90,255,170,.08); }
    .grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: repeat(3,1fr); } }
    @media (max-width: 820px)  { .grid { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 520px)  { .grid { grid-template-columns: 1fr; } }
    .card { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.10); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; min-height:240px; }
    .card:hover { border-color: rgba(64,140,255,.35); }
    .img { height:140px; background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); display:grid; place-items:center; overflow:hidden; }
    .img img { width:100%; height:100%; object-fit:cover; display:block; }
    .img .placeholder { font-size:12px; color: rgba(232,238,246,.6); padding: 10px; text-align:center; }
    .content { padding: 12px; display:grid; gap:8px; }
    .name { font-size: 14px; line-height:1.2; font-weight: 850; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:12px; color: rgba(232,238,246,.75); }
    .tag { padding:4px 8px; border-radius:999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); }
    .desc { font-size:12px; line-height:1.35; color: rgba(232,238,246,.72); max-height: 3.9em; overflow:hidden; }
    .swatch { display:inline-flex; gap:8px; align-items:center; }
    .swatch-box { width:18px; height:18px; border-radius:6px; border:1px solid rgba(255,255,255,.18); background:#555; box-shadow: inset 0 0 0 1px rgba(0,0,0,.25); }
    .footer { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:6px; font-size:12px; color: rgba(232,238,246,.75); }
    a.link { color: rgba(64,140,255,.95); text-decoration:none; font-weight:750; }
    a.link:hover { text-decoration:underline; }
    .muted { color: rgba(232,238,246,.65); }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Spandex AU — Products for baseProductCode: 955</h1>

    <div class="controls">
      <input id="q" type="search" placeholder="Search name/code/base/desc..." />
      <select id="sort">
        <option value="name_asc">Sort: Name A→Z</option>
        <option value="name_desc">Sort: Name Z→A</option>
        <option value="code_asc">Sort: Code A→Z</option>
        <option value="code_desc">Sort: Code Z→A</option>
      </select>

      <label class="toggle" title="Only show products with a valid #RRGGBB colourHex">
        <input id="onlyHex" type="checkbox" />
        Only with colourHex
      </label>

      <input id="token" type="text" spellcheck="false" placeholder="Bearer token (optional override)" />

      <button id="load">Load products</button>
    </div>

    <div class="row">
      <span class="pill"><span class="dot" id="dot"></span><span id="summary">Idle</span></span>
      <span class="pill">Shown: <strong id="shown">0</strong> <span class="muted">/ Loaded:</span> <strong id="loaded">0</strong></span>
      <span class="pill">TotalResults: <strong id="total">?</strong></span>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="status muted">
    Click <strong>Load products</strong> to fetch and render cards.
  </div>
  <div id="grid" class="grid"></div>
</main>

<script>
(() => {
  // Same baseUrl as your working console script (keep it encoded!)
  const BASE_URL =
    "https://api-shop.spandex.com/occ/v2/AU_Site/products/search?fields=products(code%2Cname%2CbaseProduct%2CbaseProductName%2CshortDescription%2Curl%2CstatusOptions%2CgreenProduct%2Cclassifications%2Cprice(FULL)%2CslittingOption%2CcolourCommercial%2CcolourHex%2CpreviewImage(FULL)%2CbrandImage(FULL)%2CsalesUnit(FULL)%2CadditionalSalesUnits(FULL)%2Cpurchasable%2CminOrderQuantity%2CorderQuantityInterval%2CcolourFinish%2Cdeclaration)%2Cfacets(FULL)%2Cbreadcrumbs%2CsubCategoryCodes%2Cpagination(DEFAULT)%2Csorts(DEFAULT)%2CfreeTextSearch%2CcurrentQuery&query=%3A%3AbaseProductCode%3A955&searchQueryContext=PDP&lang=en_AU&curr=AUD";

  const PAGE_SIZE = 100; // confirmed API cap
  const DEFAULT_TOKEN = "Bearer FRoDCDZfPdRjH7mTr4dwi1YXboY"; // replace if needed

  const els = {
    q: document.getElementById("q"),
    sort: document.getElementById("sort"),
    onlyHex: document.getElementById("onlyHex"),
    load: document.getElementById("load"),
    token: document.getElementById("token"),
    status: document.getElementById("status"),
    grid: document.getElementById("grid"),
    shown: document.getElementById("shown"),
    loaded: document.getElementById("loaded"),
    total: document.getElementById("total"),
    summary: document.getElementById("summary"),
    dot: document.getElementById("dot"),
  };

  let rawProducts = [];

  function setState(text, kind = "muted", dot = "#777") {
    els.status.className = `status ${kind}`;
    els.status.textContent = text;
    els.summary.textContent = text;
    els.dot.style.background = dot;
  }

  function safeText(v) {
    if (v == null) return "";
    return String(v).replace(/\s+/g, " ").trim();
  }

  function isValidHex(s) {
    if (!s || typeof s !== "string") return false;
    const v = s.trim();
    return /^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{3})$/.test(v);
  }

  function getImageUrl(p) {
    const img = p?.previewImage;
    if (!img) return "";
    if (typeof img === "string") return img;
    if (img.url) return img.url;
    if (img.full?.url) return img.full.url;
    if (img.FULL?.url) return img.FULL.url;
    if (Array.isArray(img.formats) && img.formats.length) {
      const sorted = [...img.formats].sort((a,b) => (b.width||0)-(a.width||0));
      return sorted[0]?.url || "";
    }
    return "";
  }

  function getPriceText(p) {
    const price = p?.price;
    if (!price) return "";
    if (price.formattedValue) return price.formattedValue;
    if (price.value != null && price.currencyIso) return `${price.currencyIso} ${price.value}`;
    if (price.FULL?.formattedValue) return price.FULL.formattedValue;
    return "";
  }

  function render() {
    const q = els.q.value.trim().toLowerCase();
    const onlyHex = els.onlyHex.checked;
    const sort = els.sort.value;

    let items = rawProducts.slice();

    if (q) {
      items = items.filter(p => {
        const hay = [
          p.name, p.code, p.baseProduct, p.baseProductName,
          p.shortDescription, p.colourCommercial, p.colourHex
        ].map(safeText).join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    if (onlyHex) items = items.filter(p => isValidHex(p.colourHex));

    const cmp = (a,b) => (a||"").localeCompare(b||"", undefined, { numeric:true, sensitivity:"base" });
    items.sort((a,b) => {
      switch (sort) {
        case "name_desc": return cmp(b.name, a.name);
        case "code_asc": return cmp(a.code, b.code);
        case "code_desc": return cmp(b.code, a.code);
        case "name_asc":
        default: return cmp(a.name, b.name);
      }
    });

    els.grid.innerHTML = items.map(p => {
      const name = safeText(p.name) || "(No name)";
      const code = safeText(p.code);
      const base = safeText(p.baseProductName || p.baseProduct);
      const desc = safeText(p.shortDescription);
      const hex = safeText(p.colourHex);
      const colourName = safeText(p.colourCommercial);
      const price = getPriceText(p);
      const url = safeText(p.url);
      const imgUrl = getImageUrl(p);

      const swatchStyle = isValidHex(hex) ? `style="background:${hex}"` : `style="background:#555"`;
      const swatchLabel = isValidHex(hex) ? hex : (hex ? `${hex} (invalid)` : "No colourHex");

      return `
        <article class="card">
          <div class="img">
            ${
              imgUrl
                ? `<img src="${imgUrl}" alt="${name.replace(/"/g, "&quot;")}">`
                : `<div class="placeholder">No preview image</div>`
            }
          </div>

          <div class="content">
            <div class="name">${name}</div>

            <div class="meta">
              ${code ? `<span class="tag">Code: ${code}</span>` : ""}
              ${base ? `<span class="tag">Base: ${base}</span>` : ""}
              ${price ? `<span class="tag">Price: ${price}</span>` : ""}
            </div>

            <div class="swatch">
              <span class="swatch-box" ${swatchStyle} title="${swatchLabel.replace(/"/g, "&quot;")}"></span>
              <span class="tag">${colourName || "Colour"}</span>
              <span class="tag">${swatchLabel}</span>
            </div>

            ${desc ? `<div class="desc">${desc}</div>` : ""}

            <div class="footer">
              <span>${p.purchasable === false ? "Not purchasable" : (p.purchasable === true ? "Purchasable" : "")}</span>
              ${url ? `<a class="link" href="https://shop.spandex.com${url}" target="_blank" rel="noopener">Open</a>` : ""}
            </div>
          </div>
        </article>
      `;
    }).join("");

    els.shown.textContent = String(items.length);
  }

  async function fetchAll() {
    const token = safeText(els.token.value) || DEFAULT_TOKEN;

    if (!token.toLowerCase().startsWith("bearer ")) {
      setState("Token missing/invalid. Paste a valid 'Bearer …' token in the token box.", "error", "#ff5a5a");
      return;
    }

    setState("Fetching…", "", "#408cff");
    rawProducts = [];
    els.loaded.textContent = "0";
    els.total.textContent = "?";
    render();

    const headers = {
      accept: "application/json, text/plain, */*",
      authorization: token
    };

    const all = [];
    let currentPage = 0;
    let totalResults = Infinity;

    while (all.length < totalResults) {
      const url = `${BASE_URL}&pageSize=${PAGE_SIZE}&currentPage=${currentPage}`;

      const res = await fetch(url, { method: "GET", headers });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        setState(`HTTP ${res.status} on page ${currentPage}: ${txt.slice(0, 300)}`, "error", "#ff5a5a");
        throw new Error(`HTTP ${res.status} page ${currentPage}`);
      }

      const data = await res.json();
      const products = data.products || [];
      const pag = data.pagination || {};

      totalResults = Number(pag.totalResults ?? totalResults);
      els.total.textContent = isFinite(totalResults) ? String(totalResults) : "?";

      all.push(...products);

      setState(`Page ${currentPage} -> +${products.length} (collected ${all.length}/${totalResults})`, "", "#408cff");
      els.loaded.textContent = String(all.length);

      if (products.length === 0) break;
      currentPage++;
    }

    // De-dupe by code
    const byCode = new Map();
    for (const p of all) byCode.set(p.code, p);
    rawProducts = Array.from(byCode.values());

    // expose like your script
    window.spandexProducts = rawProducts;

    els.loaded.textContent = String(rawProducts.length);
    setState(`Done. Unique products: ${rawProducts.length}`, "ok", "#5affaa");
    render();
  }

  // Wire up
  els.load.addEventListener("click", () => fetchAll().catch(console.error));
  els.q.addEventListener("input", render);
  els.sort.addEventListener("change", render);
  els.onlyHex.addEventListener("change", render);

  // initial
  els.token.value = DEFAULT_TOKEN;
  render();
})();
</script>
</body>
</html>
